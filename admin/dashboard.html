<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Gateway Dashboard</title>
    <!-- Tabler Core CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta20/dist/css/tabler.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css">
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Intro.js -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intro.js@7.2.0/introjs.min.css">
    <script src="https://cdn.jsdelivr.net/npm/intro.js@7.2.0/intro.min.js"></script>
    <style>
        .qr-code {
            width: 280px;
            height: 280px;
            border: 1px solid var(--tblr-border-color);
            background: white;
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.9rem;
            color: #6c757d;
            margin: 0 auto;
        }

        .log-box {
            height: 450px;
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'JetBrains Mono', 'Fira Code', 'Menlo', 'Courier New', Courier, monospace;
            padding: 1rem;
            overflow-y: auto;
            border-radius: 0 0 4px 4px;
            font-size: 0.85rem;
            line-height: 1.5;
            border: 1px solid #1e293b;
        }

        .log-entry {
            display: flex;
            margin-bottom: 0.15rem;
            border-left: 3px solid transparent;
            padding-left: 0.5rem;
        }

        .log-entry:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .log-time {
            color: #64748b;
            margin-right: 0.75rem;
            flex-shrink: 0;
        }

        .log-context {
            color: #38bdf8;
            font-weight: 600;
            margin-right: 0.75rem;
            flex-shrink: 0;
            cursor: pointer;
        }

        .log-level {
            margin-right: 0.75rem;
            flex-shrink: 0;
            font-weight: bold;
            width: 45px;
            text-align: center;
            border-radius: 3px;
            font-size: 0.7rem;
        }

        .level-info { color: #10b981; border-left-color: #10b981; }
        .lvl-info-badge { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .level-warn { color: #f59e0b; border-left-color: #f59e0b; }
        .lvl-warn-badge { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .level-error { color: #ef4444; border-left-color: #ef4444; }
        .lvl-error-badge { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .level-debug { color: #94a3b8; border-left-color: #94a3b8; }
        .lvl-debug-badge { background: rgba(148, 163, 184, 0.2); color: #94a3b8; }

        .terminal-toolbar {
            background-color: #1e293b;
            border: 1px solid #334155;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .terminal-search, .terminal-filter {
            background: #0f172a;
            border: 1px solid #475569;
            color: #f8fafc;
            padding: 0.2rem 0.75rem;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .message-item {
            transition: all 0.2s ease;
        }

        .message-item:hover {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body>
    <div class="page">
        <!-- Navbar -->
        <header class="navbar navbar-expand-md d-print-none">
            <div class="container-xl">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar-menu">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <h1 class="navbar-brand navbar-brand-autodark d-none-運動-block pe-0 pe-md-3" 
                    data-intro="Bienvenue sur votre tableau de bord WhatsApp Gateway ! Ce guide va vous aider à démarrer." data-step="1">
                    <a href=".">
                        <i class="ti ti-brand-whatsapp text-success me-2" style="font-size: 1.5rem;"></i>
                        WhatsApp Gateway
                    </a>
                </h1>
                <div class="navbar-nav flex-row order-md-last">
                    <div class="nav-item d-none d-md-flex me-3">
                        <div class="btn-list">
                            <button class="btn btn-icon btn-outline-info" id="start-tour" title="Démarrer le guide"
                                data-intro="Besoin d'aide ? Cliquez ici à tout moment pour relancer ce guide." data-step="7">
                                <i class="ti ti-help"></i>
                            </button>
                            <button class="btn btn-icon btn-outline-secondary" id="theme-toggler" title="Toggle theme">
                                <i class="ti ti-sun"></i>
                            </button>
                        </div>
                    </div>
                    <div class="nav-item dropdown">
                        <a href="#" class="nav-link d-flex lh-1 text-reset p-0" data-bs-toggle="dropdown">
                            <span class="avatar avatar-sm ti ti-user"></span>
                            <div class="d-none d-xl-block ps-2">
                                <div id="currentUser">Loading...</div>
                                <div class="mt-1 small text-muted">Administrator</div>
                            </div>
                        </a>
                        <div class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
                            <a href="#" class="dropdown-item" id="logout-btn">Logout</a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <header class="navbar-expand-md">
            <div class="collapse navbar-collapse" id="navbar-menu">
                <div class="navbar">
                    <div class="container-xl">
                        <ul class="navbar-nav">
                            <li class="nav-item active">
                                <a class="nav-link" href="/admin/dashboard.html">
                                    <span class="nav-link-icon d-md-none d-lg-inline-block">
                                        <i class="ti ti-dashboard"></i>
                                    </span>
                                    <span class="nav-link-title">Dashboard</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/admin/campaigns.html">
                                    <span class="nav-link-icon d-md-none d-lg-inline-block">
                                        <i class="ti ti-send"></i>
                                    </span>
                                    <span class="nav-link-title">Campaigns</span>
                                </a>
                            </li>
                            <li class="nav-item" id="nav-users" style="display: none;">
                                <a class="nav-link" href="/admin/users.html">
                                    <span class="nav-link-icon d-md-none d-lg-inline-block">
                                        <i class="ti ti-users"></i>
                                    </span>
                                    <span class="nav-link-title">Users</span>
                                </a>
                            </li>
                            <li class="nav-item" id="nav-activities" style="display: none;">
                                <a class="nav-link" href="/admin/activities.html">
                                    <span class="nav-link-icon d-md-none d-lg-inline-block">
                                        <i class="ti ti-list-check"></i>
                                    </span>
                                    <span class="nav-link-title">Activities</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </header>

        <div class="page-wrapper">
            <!-- Page header -->
            <div class="page-header d-print-none">
                <div class="container-xl">
                    <div class="row g-2 align-items-center">
                        <div class="col">
                            <h2 class="page-title">
                                Overview
                            </h2>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page body -->
            <div class="page-body">
                <div class="container-xl">
                    <!-- Session Management Section -->
                    <div class="card mb-3" data-intro="Ici, vous gérez vos instances WhatsApp. Chaque session correspond à un compte WhatsApp." data-step="2">
                        <div class="card-header">
                            <h3 class="card-title">Session Management</h3>
                            <div class="card-actions">
                                <div class="input-group">
                                    <input type="text" id="sessionIdInput" class="form-control" placeholder="New Session ID"
                                        data-intro="Étape 1 : Donnez un nom unique à votre session (ex: 'Bureau', 'Support')." data-step="3">
                                    <button id="createSessionBtn" class="btn btn-primary"
                                        data-intro="Étape 2 : Cliquez ici pour initialiser la session. Un QR code apparaîtra ci-dessous." data-step="4">Create</button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row row-cards" id="sessions-container"
                                data-intro="Vos sessions actives s'afficheront ici. Vous pourrez y voir le statut et scanner le QR code." data-step="5">
                                <!-- Sessions will be dynamically inserted here -->
                            </div>
                        </div>
                    </div>

                    <!-- API Control Section -->
                    <div class="card mb-3" data-intro="Le Control Center vous permet de tester l'envoi de messages manuellement via l'API." data-step="6">
                        <div class="card-header">
                            <ul class="nav nav-tabs card-header-tabs" id="api-tabs" role="tablist">
                                <li class="nav-item">
                                    <a class="nav-link active" id="text-tab" data-bs-toggle="tab" href="#text-panel">
                                        <i class="ti ti-message-text me-1"></i> Text
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="image-tab" data-bs-toggle="tab" href="#image-panel">
                                        <i class="ti ti-photo me-1"></i> Image
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="document-tab" data-bs-toggle="tab" href="#document-panel">
                                        <i class="ti ti-file me-1"></i> Document
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="audio-tab" data-bs-toggle="tab" href="#audio-panel">
                                        <i class="ti ti-microphone me-1"></i> Audio
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="video-tab" data-bs-toggle="tab" href="#video-panel">
                                        <i class="ti ti-video me-1"></i> Video
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="combo-tab" data-bs-toggle="tab" href="#combo-panel">
                                        <i class="ti ti-layers-intersect me-1"></i> Bulk
                                    </a>
                                </li>
                            </ul>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Active Session</label>
                                        <select class="form-select" id="api-session-id"></select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Recipient</label>
                                        <input type="text" class="form-control" id="api-recipient" placeholder="Phone or Group ID">
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="tab-content">
                                        <!-- Text Panel -->
                                        <div class="tab-pane fade show active" id="text-panel">
                                            <div class="mb-3">
                                                <textarea class="form-control" id="text-message" rows="4" placeholder="Your message here..."></textarea>
                                            </div>
                                            <button class="btn btn-primary" onclick="sendTextMessage()">
                                                <i class="ti ti-send me-1"></i> Send Text
                                            </button>
                                        </div>

                                        <!-- Image Panel -->
                                        <div class="tab-pane fade" id="image-panel">
                                            <div class="mb-3">
                                                <label class="form-label">Caption</label>
                                                <input type="text" class="form-control" id="image-caption" placeholder="Optional caption...">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Image URL</label>
                                                <input type="text" class="form-control" id="image-url" placeholder="https://...">
                                            </div>
                                            <div class="hr-text">OR</div>
                                            <div class="mb-3">
                                                <label class="form-label">Upload Image</label>
                                                <input class="form-control" type="file" id="image-upload" accept="image/*">
                                            </div>
                                            <div id="image-preview" class="mt-2" style="max-width: 200px;"></div>
                                            <button class="btn btn-primary mt-2" onclick="sendImageMessage()">
                                                <i class="ti ti-send me-1"></i> Send Image
                                            </button>
                                        </div>

                                        <!-- Document Panel -->
                                        <div class="tab-pane fade" id="document-panel">
                                            <div class="mb-3">
                                                <label class="form-label">Document URL</label>
                                                <input type="text" class="form-control" id="document-url" placeholder="https://...">
                                            </div>
                                            <div class="hr-text">OR</div>
                                            <div class="mb-3">
                                                <label class="form-label">Upload Document</label>
                                                <input class="form-control" type="file" id="document-upload">
                                            </div>
                                            <button class="btn btn-primary mt-2" onclick="sendDocumentMessage()">
                                                <i class="ti ti-send me-1"></i> Send Document
                                            </button>
                                        </div>

                                        <!-- Audio Panel -->
                                        <div class="tab-pane fade" id="audio-panel">
                                            <div class="mb-3">
                                                <label class="form-label">Audio URL</label>
                                                <input type="text" class="form-control" id="audio-url" placeholder="https://...">
                                            </div>
                                            <div class="hr-text">OR</div>
                                            <div class="mb-3">
                                                <label class="form-label">Upload Audio</label>
                                                <input class="form-control" type="file" id="audio-upload" accept="audio/*">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="audio-ptt">
                                                    <span class="form-check-label">Send as Voice Note (PTT)</span>
                                                </label>
                                            </div>
                                            <button class="btn btn-primary" onclick="sendAudioMessage()">
                                                <i class="ti ti-send me-1"></i> Send Audio
                                            </button>
                                        </div>

                                        <!-- Video Panel -->
                                        <div class="tab-pane fade" id="video-panel">
                                            <div class="mb-3">
                                                <label class="form-label">Caption</label>
                                                <input type="text" class="form-control" id="video-caption" placeholder="Optional caption...">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Video URL</label>
                                                <input type="text" class="form-control" id="video-url" placeholder="https://...">
                                            </div>
                                            <div class="hr-text">OR</div>
                                            <div class="mb-3">
                                                <label class="form-label">Upload Video</label>
                                                <input class="form-control" type="file" id="video-upload" accept="video/*">
                                            </div>
                                            <button class="btn btn-primary mt-2" onclick="sendVideoMessage()">
                                                <i class="ti ti-send me-1"></i> Send Video
                                            </button>
                                        </div>

                                        <!-- Combo Panel -->
                                        <div class="tab-pane fade" id="combo-panel">
                                            <div class="alert alert-info bg-info-lt border-info">
                                                <div class="d-flex">
                                                    <i class="ti ti-info-circle me-2 mt-1"></i>
                                                    <div>
                                                        <strong>Bulk Messaging:</strong> Send multiple message types in a single request.
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row g-3">
                                                <div class="col-12">
                                                    <label class="form-label font-weight-bold">
                                                        <i class="ti ti-message-2 me-1"></i> Text Message
                                                    </label>
                                                    <textarea class="form-control" id="combo-text-message" rows="3" placeholder="Your text message..."></textarea>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label font-weight-bold">
                                                        <i class="ti ti-photo me-1"></i> Image URL
                                                    </label>
                                                    <input type="text" class="form-control" id="combo-image-url" placeholder="https://...">
                                                    <div class="mt-2">
                                                        <label class="form-label small text-muted">Or upload image</label>
                                                        <input type="file" class="form-control form-control-sm" id="combo-image-upload" accept="image/*">
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label font-weight-bold">
                                                        <i class="ti ti-file-description me-1"></i> Document URL
                                                    </label>
                                                    <input type="text" class="form-control" id="combo-document-url" placeholder="https://...">
                                                    <div class="mt-2">
                                                        <label class="form-label small text-muted">Or upload document</label>
                                                        <input type="file" class="form-control form-control-sm" id="combo-document-upload">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mt-4">
                                                <button class="btn btn-primary w-100" onclick="sendComboMessage()">
                                                    <i class="ti ti-send me-1"></i> Send Bulk Message
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- API Usage & Response -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h3 class="card-title">API Usage Example (cURL)</h3>
                        </div>
                        <div class="card-body">
                            <div class="position-relative">
                                <pre class="bg-dark text-white p-3 rounded mb-0" style="min-height: 60px;"><code id="api-usage-example" style="white-space: pre-wrap; font-family: 'JetBrains Mono', monospace;">Select an option above to see usage...</code></pre>
                                <button class="btn btn-sm btn-secondary position-absolute top-0 end-0 m-2" onclick="copyToClipboardFromCode('api-usage-example', this)">
                                    <i class="ti ti-copy"></i>
                                </button>
                            </div>
                            <div id="api-response" class="mt-3"></div>
                        </div>
                    </div>
        </section>

        <section id="api-reference" class="mb-5">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">API Reference & Example cURL Commands</h5>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs mb-3" id="curlExampleTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="curl-sessions-tab" data-bs-toggle="tab"
                                data-bs-target="#curl-sessions" type="button" role="tab">Session Management</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="curl-text-tab" data-bs-toggle="tab" data-bs-target="#curl-text"
                                type="button" role="tab">Text</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="curl-audio-tab" data-bs-toggle="tab" data-bs-target="#curl-audio"
                                type="button" role="tab">Audio</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="curl-video-tab" data-bs-toggle="tab" data-bs-target="#curl-video"
                                type="button" role="tab">Video</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="curl-text-image-tab" data-bs-toggle="tab"
                                data-bs-target="#curl-text-image" type="button" role="tab">Text + Image</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="curl-text-image-doc-tab" data-bs-toggle="tab"
                                data-bs-target="#curl-text-image-doc" type="button" role="tab">Text + Image +
                                Document</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="curl-text-doc-tab" data-bs-toggle="tab"
                                data-bs-target="#curl-text-doc" type="button" role="tab">Text + Document</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="curl-formatting-tab" data-bs-toggle="tab"
                                data-bs-target="#curl-formatting" type="button" role="tab">Formatting</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="curl-webhook-tab" data-bs-toggle="tab"
                                data-bs-target="#curl-webhook" type="button" role="tab">Webhook</button>
                        </li>
                    </ul>
                    <div class="tab-content" id="curlExampleTabsContent">
                        <div class="tab-pane fade show active" id="curl-sessions" role="tabpanel">
                            <div class="mb-2"><strong>Session Management</strong></div>
                            <div class="mb-3">
                                <strong>Create Session (API Access)</strong>
                                <pre><code id="curl-create-session">curl -X POST "http://localhost:3000/api/v1/sessions" \
-H "X-Master-Key: YOUR_MASTER_API_KEY" \
-H "Content-Type: application/json" \
-d '{
  "sessionId": "myNewSession"
}'</code></pre>
                                <button class="btn btn-sm btn-outline-secondary mb-2"
                                    onclick="copyCurl('curl-create-session', this)">Copy</button>
                                <div class="alert alert-info mt-2">
                                    <i class="bi bi-info-circle"></i> <strong>Note:</strong> The Master API Key is
                                    required for creating sessions via API. Find it in your <code>.env</code> file.
                                    Admin dashboard users don't need the key.
                                </div>
                            </div>
                            <div class="mb-3">
                                <strong>List All Sessions</strong>
                                <pre><code id="curl-list-sessions">curl -X GET "http://localhost:3000/api/v1/sessions"</code></pre>
                                <button class="btn btn-sm btn-outline-secondary mb-2"
                                    onclick="copyCurl('curl-list-sessions', this)">Copy</button>
                            </div>
                            <div class="mb-3">
                                <strong>Delete Session</strong>
                                <pre><code id="curl-delete-session">curl -X DELETE "http://localhost:3000/api/v1/sessions/mySession" \
-H "Authorization: Bearer YOUR_SESSION_TOKEN"</code></pre>
                                <button class="btn btn-sm btn-outline-secondary mb-2"
                                    onclick="copyCurl('curl-delete-session', this)">Copy</button>
                            </div>
                            <div class="text-muted small mt-2">
                                <ul>
                                    <li><b>Create Session:</b> Requires Master API Key for API access. Returns a session
                                        token.</li>
                                    <li><b>List Sessions:</b> Public endpoint - no authentication required.</li>
                                    <li><b>Delete Session:</b> Requires the session's Bearer token.</li>
                                    <li>Save the token returned from session creation - it's needed for all other
                                        operations.</li>
                                </ul>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="curl-text" role="tabpanel">
                            <div class="mb-2"><strong>Send Text Message</strong></div>
                            <pre><code id="curl-send-text">curl -X POST "http://localhost:3000/api/v1/messages?sessionId=YOUR_SESSION_ID" \
-H "Authorization: Bearer YOUR_TOKEN" \
-H "Content-Type: application/json" \
-d '{
  "recipient_type": "individual",
  "to": "6281234567890",
  "type": "text",
  "text": { "body": "Hello from the API!" }
}'</code></pre>
                            <button class="btn btn-sm btn-outline-secondary mb-2"
                                onclick="copyCurl('curl-send-text', this)">Copy</button>
                        </div>
                        <div class="tab-pane fade" id="curl-audio" role="tabpanel">
                            <div class="mb-2"><strong>Send Audio Message</strong></div>
                            <pre><code id="curl-send-audio">curl -X POST "http://localhost:3000/api/v1/messages?sessionId=YOUR_SESSION_ID" \
-H "Authorization: Bearer YOUR_TOKEN" \
-H "Content-Type: application/json" \
-d '{
  "recipient_type": "individual",
  "to": "6281234567890",
  "type": "audio",
  "audio": {
    "link": "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3",
    "ptt": false
  }
}'</code></pre>
                            <button class="btn btn-sm btn-outline-secondary mb-2"
                                onclick="copyCurl('curl-send-audio', this)">Copy</button>
                            <div class="text-muted small mt-2">
                                <ul>
                                    <li>Set <code>ptt: true</code> to send as a voice note.</li>
                                </ul>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="curl-video" role="tabpanel">
                            <div class="mb-2"><strong>Send Video Message</strong></div>
                            <pre><code id="curl-send-video">curl -X POST "http://localhost:3000/api/v1/messages?sessionId=YOUR_SESSION_ID" \
-H "Authorization: Bearer YOUR_TOKEN" \
-H "Content-Type: application/json" \
-d '{
  "recipient_type": "individual",
  "to": "6281234567890",
  "type": "video",
  "video": {
    "link": "https://www.w3schools.com/html/mov_bbb.mp4",
    "caption": "Check out this video!"
  }
}'</code></pre>
                            <button class="btn btn-sm btn-outline-secondary mb-2"
                                onclick="copyCurl('curl-send-video', this)">Copy</button>
                        </div>
                        <div class="tab-pane fade" id="curl-text-image" role="tabpanel">
                            <div class="mb-2"><strong>Send Text + Image</strong></div>
                            <pre><code id="curl-send-text-image">curl -X POST "http://localhost:3000/api/v1/messages?sessionId=YOUR_SESSION_ID" \
-H "Authorization: Bearer YOUR_TOKEN" \
-H "Content-Type: application/json" \
-d '{
  "recipient_type": "individual",
  "to": "6281234567890",
  "type": "image",
  "image": {
    "link": "https://picsum.photos/200",
    "caption": "This is a test image.\nWith a new line!"
  }
}'</code></pre>
                            <button class="btn btn-sm btn-outline-secondary mb-2"
                                onclick="copyCurl('curl-send-text-image', this)">Copy</button>
                        </div>
                        <div class="tab-pane fade" id="curl-text-image-doc" role="tabpanel">
                            <div class="mb-2"><strong>Send Text + Image + Document</strong></div>
                            <pre><code id="curl-send-text-image-doc">curl -X POST "http://localhost:3000/api/v1/messages?sessionId=YOUR_SESSION_ID" \
-H "Authorization: Bearer YOUR_TOKEN" \
-H "Content-Type: application/json" \
-d '[
  {
    "recipient_type": "individual",
    "to": "6281234567890",
    "type": "text",
    "text": { "body": "Here is an image and a document!" }
  },
  {
    "recipient_type": "individual",
    "to": "6281234567890",
    "type": "image",
    "image": {
      "link": "https://picsum.photos/200",
      "caption": "Image caption."
    }
  },
  {
    "recipient_type": "individual",
    "to": "6281234567890",
    "type": "document",
    "document": {
      "link": "https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf",
      "mimetype": "application/pdf",
      "filename": "dummy.pdf"
    }
  }
]'</code></pre>
                            <button class="btn btn-sm btn-outline-secondary mb-2"
                                onclick="copyCurl('curl-send-text-image-doc', this)">Copy</button>
                        </div>
                        <div class="tab-pane fade" id="curl-text-doc" role="tabpanel">
                            <div class="mb-2"><strong>Send Text + Document</strong></div>
                            <pre><code id="curl-send-text-doc">curl -X POST "http://localhost:3000/api/v1/messages?sessionId=YOUR_SESSION_ID" \
-H "Authorization: Bearer YOUR_TOKEN" \
-H "Content-Type: application/json" \
-d '[
  {
    "recipient_type": "individual",
    "to": "6281234567890",
    "type": "text",
    "text": { "body": "Here is a document!" }
  },
  {
    "recipient_type": "individual",
    "to": "6281234567890",
    "type": "document",
    "document": {
      "link": "https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf",
      "mimetype": "application/pdf",
      "filename": "dummy.pdf"
    }
  }
]'</code></pre>
                            <button class="btn btn-sm btn-outline-secondary mb-2"
                                onclick="copyCurl('curl-send-text-doc', this)">Copy</button>
                        </div>
                        <div class="tab-pane fade" id="curl-formatting" role="tabpanel">
                            <div class="mb-2"><strong>Formatting: New Lines, Bold, and Links</strong></div>
                            <pre><code id="curl-send-formatting">curl -X POST "http://localhost:3000/api/v1/messages?sessionId=YOUR_SESSION_ID" \
-H "Authorization: Bearer YOUR_TOKEN" \
-H "Content-Type: application/json" \
-d '{
  "recipient_type": "individual",
  "to": "6281234567890",
  "type": "text",
  "text": { "body": "Hello!\nThis is a new line.\n*This is bold text!*\nVisit: https://example.com" }
}'</code></pre>
                            <button class="btn btn-sm btn-outline-secondary mb-2"
                                onclick="copyCurl('curl-send-formatting', this)">Copy</button>
                            <div class="text-muted small mt-2">
                                <ul>
                                    <li>Use <code>\n</code> for new lines.</li>
                                    <li>Use <code>*bold text*</code> for <b>bold</b> (WhatsApp formatting).</li>
                                    <li>Paste a URL directly to make it clickable in WhatsApp.</li>
                                </ul>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="curl-webhook" role="tabpanel">
                            <div class="mb-2"><strong>Manage Webhook for a Session</strong></div>
                            <div class="mb-3">
                                <strong>Set Webhook</strong>
                                <pre><code id="curl-set-webhook">curl -X POST "http://localhost:3000/api/v1/webhook" \
-H "Authorization: Bearer YOUR_TOKEN" \
-H "Content-Type: application/json" \
-d '{
  "sessionId": "YOUR_SESSION_ID",
  "url": "https://your-webhook-receiver.com/events"
}'</code></pre>
                                <button class="btn btn-sm btn-outline-secondary mb-2"
                                    onclick="copyCurl('curl-set-webhook', this)">Copy</button>
                            </div>
                            <div class="mb-3">
                                <strong>Get Webhook</strong>
                                <pre><code id="curl-get-webhook">curl -X GET "http://localhost:3000/api/v1/webhook?sessionId=YOUR_SESSION_ID" \
-H "Authorization: Bearer YOUR_TOKEN"</code></pre>
                                <button class="btn btn-sm btn-outline-secondary mb-2"
                                    onclick="copyCurl('curl-get-webhook', this)">Copy</button>
                            </div>
                            <div class="mb-3">
                                <strong>Delete Webhook</strong>
                                <pre><code id="curl-delete-webhook">curl -X DELETE "http://localhost:3000/api/v1/webhook" \
-H "Authorization: Bearer YOUR_TOKEN" \
-H "Content-Type: application/json" \
-d '{
  "sessionId": "YOUR_SESSION_ID"
}'</code></pre>
                                <button class="btn btn-sm btn-outline-secondary mb-2"
                                    onclick="copyCurl('curl-delete-webhook', this)">Copy</button>
                            </div>
                            <div class="text-muted small mt-2">
                                <ul>
                                    <li><b>Set Webhook:</b> Assigns a webhook URL for a specific session. All events for
                                        that session will be sent to the specified URL.</li>
                                    <li><b>Get Webhook:</b> Retrieves the current webhook URL for a session.</li>
                                    <li><b>Delete Webhook:</b> Removes the webhook for a session. No events will be sent
                                        until a new webhook is set.</li>
                                    <li>Each session can have its own webhook URL. To update, call <b>Set Webhook</b>
                                        again with the same <code>sessionId</code>.</li>
                                    <li>Events include: new messages, session status changes, and more.</li>
                                    <li>Webhook payloads always include <code>sessionId</code> for context.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <script>
            function copyCurl(id, btn) {
                const el = document.getElementById(id);
                navigator.clipboard.writeText(el.textContent).then(() => {
                    if (btn) {
                        const original = btn.innerHTML;
                        btn.innerHTML = '<i class="bi bi-clipboard-check"></i>';
                        btn.classList.remove('btn-outline-secondary');
                        btn.classList.add('btn-info');
                        btn.style.borderRadius = '6px';
                        setTimeout(() => {
                            btn.innerHTML = original;
                            btn.classList.remove('btn-info');
                            btn.classList.add('btn-outline-secondary');
                            btn.style.borderRadius = '';
                        }, 1200);
                    }
                });
            }
        </script>
        <!-- System Logs Section -->
        <div class="card mb-3">
            <div class="card-header bg-dark text-white py-2">
                <div class="d-flex align-items-center w-100">
                    <span class="badge bg-success bullet pulse me-2"></span>
                    <h3 class="card-title text-white mb-0">System Logs (Live)</h3>
                    <div class="ms-auto d-flex gap-2">
                        <select id="log-session-filter" class="form-select form-select-sm bg-dark text-white border-secondary" style="width: auto;">
                            <option value="all">All Sessions</option>
                            <option value="SYSTEM">SYSTEM</option>
                        </select>
                        <select id="log-level-filter" class="form-select form-select-sm bg-dark text-white border-secondary" style="width: auto;">
                            <option value="all">All Levels</option>
                            <option value="INFO">Info</option>
                            <option value="WARN">Warnings</option>
                            <option value="ERROR">Errors</option>
                        </select>
                        <input type="text" id="log-search" class="form-control form-control-sm bg-dark text-white border-secondary" placeholder="Search logs..." style="width: 150px;">
                        <div class="btn-group">
                            <button id="pause-logs-btn" class="btn btn-sm btn-ghost-light">
                                <i class="ti ti-pause me-1"></i> Pause
                            </button>
                            <button id="clear-logs-btn" class="btn btn-sm btn-ghost-light">
                                <i class="ti ti-trash me-1"></i> Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="log-box" class="log-box" style="height: 400px; overflow-y: auto; background: #0f172a; color: #e2e8f0; font-family: 'JetBrains Mono', monospace; padding: 1rem;">
                    <div class="log-entry level-info">
                        <span class="log-msg">Connecting to live feed...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Log History Section -->
        <section id="system-log-history" class="mb-5">
            <div class="card shadow-sm">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">System Log History</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-light ms-2" onclick="toggleBulkSelect()"
                                id="bulkSelectBtn">
                                <i class="bi bi-check-square"></i> Select
                            </button>
                            <button class="btn btn-sm btn-outline-danger ms-2 d-none" onclick="deleteSelectedLogs()"
                                id="deleteSelectedBtn">
                                <i class="bi bi-trash"></i> Delete Selected
                            </button>
                            <button class="btn btn-sm btn-outline-light ms-2" onclick="refreshSystemLog()">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                            <button class="btn btn-sm btn-outline-light ms-2" onclick="exportSystemLog()">
                                <i class="bi bi-download"></i> Export
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="bulk-actions d-none mb-3" id="bulkActions">
                        <div class="d-flex justify-content-between align-items-center p-2 bg-body-secondary rounded">
                            <div>
                                <input type="checkbox" class="form-check-input me-2" id="selectAllCheckbox"
                                    onchange="selectAllLogs()">
                                <label for="selectAllCheckbox" class="form-check-label">Select All</label>
                                <span class="ms-3 text-muted" id="selectedCount">0 selected</span>
                            </div>
                            <button class="btn btn-sm btn-outline-secondary"
                                onclick="cancelBulkSelect()">Cancel</button>
                        </div>
                    </div>
                    <div id="systemLogHistory">
                        <!-- Log entries will be rendered here -->
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Image Lightbox Modal -->
    <div id="imageLightbox" class="modal fade" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content bg-transparent border-0">
                <div class="modal-header border-0">
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body text-center p-0">
                    <img id="lightboxImage" src="" class="img-fluid" style="max-height: 90vh;">
                </div>
            </div>
        </div>
    </div>

    <footer class="text-center text-muted py-4">
        <small>Super-Light-Web-WhatsApp-API-Server by Alucard0x1</small>
    </footer>

    <script src="/admin/js/bootstrap.bundle.min.js"></script>
    <script src="/admin/js/qrcode.min.js"></script>

    <script>
        // DOM sanitization utility
        function sanitize(str) {
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        }
        // Patch all DOM insertions to use sanitize()
        // Example: logEntry.textContent = ... is safe, but innerHTML = ... should use sanitize()
        // --- THEME TOGGLER ---
        const themeToggler = document.getElementById('theme-toggler');
        const themeIcon = themeToggler.querySelector('i');
        const getPreferredTheme = () => {
            if (localStorage.getItem('theme')) {
                return localStorage.getItem('theme');
            }
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        };
        const setTheme = (theme) => {
            if (theme === 'dark') {
                document.documentElement.setAttribute('data-bs-theme', 'dark');
                themeIcon.classList.remove('bi-sun-fill');
                themeIcon.classList.add('bi-moon-stars-fill');
            } else {
                document.documentElement.setAttribute('data-bs-theme', 'light');
                themeIcon.classList.remove('bi-moon-stars-fill');
                themeIcon.classList.add('bi-sun-fill');
            }
            localStorage.setItem('theme', theme);
        };
        setTheme(getPreferredTheme());
        themeToggler.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-bs-theme');
            setTheme(currentTheme === 'dark' ? 'light' : 'dark');
        });

        const sessionsContainer = document.getElementById('sessions-container');
        const createSessionBtn = document.getElementById('createSessionBtn');
        const sessionIdInput = document.getElementById('sessionIdInput');

        const sessionsData = new Map(); // Store full session data including token

        const apiSessionIdSelect = document.getElementById('api-session-id');
        const apiRecipientInput = document.getElementById('api-recipient');
        const apiUsageExample = document.getElementById('api-usage-example');
        const apiResponseDiv = document.getElementById('api-response');
        const imageUploadInput = document.getElementById('image-upload');
        const imagePreview = document.getElementById('image-preview');

        // --- Intro.js Tour ---
        const startTourBtn = document.getElementById('start-tour');
        const startTour = () => {
            introJs().setOptions({
                nextLabel: 'Suivant',
                prevLabel: 'Précédent',
                doneLabel: 'Terminer',
                showProgress: true,
                showStepNumbers: true,
                dontShowAgain: true,
                dontShowAgainLabel: "Ne plus afficher ce guide",
                tooltipClass: 'customTooltip'
            }).start();
        };

        startTourBtn.addEventListener('click', startTour);

        // Auto-start tour for new users (check localStorage)
        if (!localStorage.getItem('tour-completed')) {
            setTimeout(() => {
                startTour();
                localStorage.setItem('tour-completed', 'true');
            }, 1500);
        }

        // --- Terminal UI Elements & State ---
        const logBox = document.getElementById('log-box');
        const logSearchInput = document.getElementById('log-search');
        const logLevelFilter = document.getElementById('log-level-filter');
        const logSessionFilter = document.getElementById('log-session-filter');
        const pauseLogsBtn = document.getElementById('pause-logs-btn');
        const clearLogsBtn = document.getElementById('clear-logs-btn');

        let logsPaused = false;
        let logBuffer = [];
        const MAX_LOGS = 500;
        let allLogs = []; // In-memory store for filtering


        // --- SweetAlert2 Helpers ---
        const showSwalAlert = (title, text, icon = 'info') => {
            return Swal.fire({
                title,
                text,
                icon,
                confirmButtonColor: '#10b981',
                customClass: {
                    popup: 'rounded-4',
                    confirmButton: 'px-4'
                }
            });
        };

        const showSwalConfirm = (title, text, icon = 'warning') => {
            return Swal.fire({
                title,
                text,
                icon,
                showCancelButton: true,
                confirmButtonColor: '#10b981',
                cancelButtonColor: '#ef4444',
                confirmButtonText: 'Confirm',
                cancelButtonText: 'Cancel',
                customClass: {
                    popup: 'rounded-4',
                    confirmButton: 'px-4',
                    cancelButton: 'px-4'
                }
            });
        };

        const showSwalLoading = (title = 'Loading...') => {
            return Swal.fire({
                title,
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                },
                customClass: {
                    popup: 'rounded-4'
                }
            });
        };

        function createSessionCard(session) {
            const card = document.createElement('div');
            card.className = 'col-md-6 col-lg-4 mb-4';
            card.id = `session-${session.sessionId}`;

            const status = session.status === 'CONNECTED' ? 'success' : 
                          (session.status === 'DISCONNECTED' ? 'danger' : 'warning');
            
            const canDelete = currentUserRole === 'admin' || session.owner === currentUserEmail;

            card.innerHTML = `
                <div class="card card-stacked">
                    <div class="card-status-top bg-${status}"></div>
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="avatar avatar-sm bg-${status}-lt me-2">
                                <i class="ti ti-brand-whatsapp"></i>
                            </div>
                            <div>
                                <h4 class="card-title mb-0">Session: ${session.sessionId}</h4>
                                <span class="badge bg-${status}-lt mt-1" id="status-${session.sessionId}">
                                    ${session.status}${session.detail ? ' - ' + session.detail : ''}
                                </span>
                            </div>
                            <div class="ms-auto">
                                ${canDelete ? `
                                <button class="btn btn-icon btn-ghost-danger btn-sm" onclick="deleteSession('${session.sessionId}')" title="Delete Session">
                                    <i class="ti ti-trash"></i>
                                </button>` : ''}
                            </div>
                        </div>
                        
                        ${session.owner ? `<div class="mb-3 small text-muted"><i class="ti ti-user me-1"></i>Owner: ${session.owner}</div>` : ''}

                        <div class="mb-3">
                            <label class="form-label small text-muted mb-1">Session Token</label>
                            <div class="input-group input-group-flat">
                                <input type="text" class="form-control form-control-sm" id="token-${session.sessionId}" value="${session.token || 'N/A'}" readonly>
                                <span class="input-group-text p-0">
                                    <button class="btn btn-link btn-sm text-muted" onclick="copyToClipboard('token-${session.sessionId}', this)">
                                        <i class="ti ti-copy"></i>
                                    </button>
                                </span>
                            </div>
                        </div>

                        <div id="qr-container-${session.sessionId}" class="text-center bg-light rounded p-3 mb-3" style="display: none; min-height: 200px;">
                            <div id="qr-${session.sessionId}" class="d-inline-block"></div>
                            <div class="mt-2 small text-muted">Scan this code with WhatsApp</div>
                        </div>

                        <div class="d-flex gap-2">
                            <button class="btn btn-primary btn-sm w-100" onclick="getQrCode('${session.sessionId}')" id="btn-qr-${session.sessionId}">
                                <i class="ti ti-qrcode me-1"></i> ${session.status === 'CONNECTED' ? 'Reconnect' : 'Get QR Code'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            return card;
        }

        function updateSessionCards(sessions) {
            sessions.forEach(s => sessionsData.set(s.sessionId, s));

            // Remove cards for sessions that no longer exist
            const existingCardIds = Array.from(sessionsContainer.children).map(c => c.id);
            const fetchedSessionIds = sessions.map(s => `session-${s.sessionId}`);
            existingCardIds.forEach(cardId => {
                if (!fetchedSessionIds.includes(cardId)) {
                    document.getElementById(cardId)?.remove();
                }
            });

            sessions.forEach(session => {
                if (!session.sessionId) {
                    console.error('Received session data without a sessionId:', session);
                    return; // Skip this entry
                }

                let card = document.getElementById(`session-${session.sessionId}`);
                if (!card) {
                    card = createSessionCard(session);
                    sessionsContainer.appendChild(card);
                }

                // --- Update Status Logic (formerly updateSessionStatus) ---
                const statusEl = document.getElementById(`status-${session.sessionId}`);
                const qrContainer = document.getElementById(`qr-container-${session.sessionId}`);
                const qrCodeEl = document.getElementById(`qr-${session.sessionId}`);
                const getQrBtn = document.getElementById(`btn-qr-${session.sessionId}`);
                const tokenEl = document.getElementById(`token-${session.sessionId}`);

                if (!statusEl || !qrContainer || !qrCodeEl || !getQrBtn || !tokenEl) {
                    console.error(`Incomplete card elements for session ${session.sessionId}. Update skipped.`);
                    return;
                }

                statusEl.textContent = `${session.status}${session.detail ? ' - ' + session.detail : ''}`;
                statusEl.className = 'badge status-badge '; // Reset classes
                if (session.status === 'CONNECTED') {
                    statusEl.classList.add('bg-success');
                    getQrBtn.style.display = 'none';
                    qrContainer.style.display = 'none';
                } else if (session.status === 'DISCONNECTED') {
                    statusEl.classList.add('bg-danger');
                    getQrBtn.style.display = 'inline-block';
                    qrContainer.style.display = 'none';
                } else { // CONNECTING, GENERATING_QR, etc.
                    statusEl.classList.add('bg-warning', 'text-dark');
                    getQrBtn.style.display = 'inline-block';
                }

                if (session.status === 'GENERATING_QR' && session.qr) {
                    qrContainer.style.display = 'block';
                    getQrBtn.style.display = 'none'; // Hide button when QR is shown
                    qrCodeEl.innerHTML = '';
                    new QRCode(qrCodeEl, { 
                        text: session.qr, 
                        width: 256, 
                        height: 256,
                        correctLevel: QRCode.CorrectLevel.H
                     });
                } else if (session.status !== 'CONNECTED') {
                    qrContainer.style.display = 'none';
                }

                if (session.token) {
                    tokenEl.value = session.token;
                }
            });
        }

        async function fetchSessions() {
            try {
                const response = await fetch('/api/v1/sessions');
                if (!response.ok) throw new Error('Failed to fetch sessions');
                const result = await response.json();
                const sessions = result.data || [];
                updateSessionCards(sessions);
                updateApiSessionSelect(sessions);
            } catch (error) {
                console.error('Error fetching sessions:', error);
            }
        }

        async function getQrCode(sessionId) {
            try {
                const response = await fetch(`/api/v1/sessions/${sessionId}/qr`, {
                    credentials: 'same-origin' // Include session cookie
                });
                const result = await response.json();
                if (!response.ok) {
                    // Only show alert if it's a real error, not just a token issue
                    if (result.message && !result.message.includes('token')) {
                        showSwalAlert('Error', result.message || result.error, 'error');
                    }
                }
                // The websocket will deliver the QR update automatically.
            } catch (error) {
                console.error('Error getting QR code:', error);
                showSwalAlert('Error', 'Failed to get QR code. Please check console for details.', 'error');
            }
        }

        async function deleteSession(sessionId) {
            const result = await showSwalConfirm(
                'Delete Session?',
                `Are you sure you want to delete session "${sessionId}"? This action cannot be undone.`,
                'warning'
            );

            if (!result.isConfirmed) return;

            const token = sessionsData.get(sessionId)?.token;
            if (!token) {
                showSwalAlert('Error', 'Could not find token for this session.', 'error');
                return;
            }

            const loading = showSwalLoading('Deleting session...');

            try {
                const response = await fetch(`/api/v1/sessions/${sessionId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const result = await response.json();
                loading.close();

                if (response.ok) {
                    showSwalAlert('Deleted', result.data ? result.data.message : 'Session deleted', 'success');
                    fetchSessions();
                } else {
                    throw new Error(result.message || 'Failed to delete session');
                }
            } catch (error) {
                loading.close();
                showSwalAlert('Error', error.message, 'error');
            }
        }



        // --- API Control Center Logic ---

        function updateApiUsage() {
            const sessionId = apiSessionIdSelect.value;
            const recipient = apiRecipientInput.value;
            if (!sessionId || !recipient) {
                apiUsageExample.textContent = 'Please select a session and enter a recipient to see an example.';
                return;
            }

            const activeTabEl = document.querySelector('#api-tabs .nav-link.active');
            if (!activeTabEl) return;
            const activeTab = activeTabEl.id;

            let payload;
            let endpoint = `/api/v1/messages?sessionId=${sessionId}`;
            const sessionData = sessionsData.get(sessionId);
            const currentToken = sessionData ? sessionData.token : '';

            if (activeTab === 'text-tab') {
                const message = document.getElementById('text-message').value;
                payload = {
                    recipient_type: recipient.includes('@g.us') ? 'group' : 'individual',
                    to: recipient,
                    type: 'text',
                    text: { body: message }
                };
            } else if (activeTab === 'image-tab') {
                const caption = document.getElementById('image-caption').value;
                const imageUrl = document.getElementById('image-url').value;
                payload = {
                    recipient_type: recipient.includes('@g.us') ? 'group' : 'individual',
                    to: recipient,
                    type: 'image',
                    image: {
                        link: imageUrl,
                        caption: caption
                    }
                };
                if (!imageUrl) {
                    apiUsageExample.textContent = `// 1. First, upload the image to /api/v1/media\n// 2. Then, use the returned mediaId in the request below.\n\n`
                }
            } else if (activeTab === 'document-tab') {
                const docUrl = document.getElementById('document-url').value;
                payload = {
                    recipient_type: recipient.includes('@g.us') ? 'group' : 'individual',
                    to: recipient,
                    type: 'document',
                    document: {
                        link: docUrl,
                        mimetype: 'application/pdf' // Example mimetype
                    }
                };
                if (!docUrl) {
                    apiUsageExample.textContent = `// 1. First, upload the document to /api/v1/media\n// 2. Then, use the returned mediaId in the request below.\n\n`
                }
            } else if (activeTab === 'audio-tab') {
                const audioUrl = document.getElementById('audio-url').value;
                const ptt = document.getElementById('audio-ptt').checked;
                payload = {
                    recipient_type: recipient.includes('@g.us') ? 'group' : 'individual',
                    to: recipient,
                    type: 'audio',
                    audio: {
                        link: audioUrl,
                        ptt: ptt
                    }
                };
                if (!audioUrl) {
                    apiUsageExample.textContent = `// 1. First, upload the audio to /api/v1/media\n// 2. Then, use the returned mediaId in the request below.\n\n`
                }
            } else if (activeTab === 'video-tab') {
                const videoUrl = document.getElementById('video-url').value;
                const caption = document.getElementById('video-caption').value;
                payload = {
                    recipient_type: recipient.includes('@g.us') ? 'group' : 'individual',
                    to: recipient,
                    type: 'video',
                    video: {
                        link: videoUrl,
                        caption: caption
                    }
                };
                if (!videoUrl) {
                    apiUsageExample.textContent = `// 1. First, upload the video to /api/v1/media\n// 2. Then, use the returned mediaId in the request below.\n\n`
                }
            } else if (activeTab === 'combo-tab') {
                // Build payload array for combo
                const payloads = [];

                // Text
                const textMessage = document.getElementById('combo-text-message').value || 'Hello! Here is an image and a document.';
                payloads.push({
                    recipient_type: recipient.includes('@g.us') ? 'group' : 'individual',
                    to: recipient,
                    type: 'text',
                    text: { body: textMessage }
                });

                // Image
                const imageCaption = document.getElementById('combo-image-caption').value || 'Image caption';
                const imageUrl = document.getElementById('combo-image-url').value || 'https://picsum.photos/200';
                payloads.push({
                    recipient_type: recipient.includes('@g.us') ? 'group' : 'individual',
                    to: recipient,
                    type: 'image',
                    image: {
                        link: imageUrl,
                        caption: imageCaption
                    }
                });

                // Document
                const docUrl = document.getElementById('combo-document-url').value || 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf';
                const docFilename = document.getElementById('combo-document-filename').value || 'document.pdf';
                payloads.push({
                    recipient_type: recipient.includes('@g.us') ? 'group' : 'individual',
                    to: recipient,
                    type: 'document',
                    document: {
                        link: docUrl,
                        mimetype: 'application/pdf',
                        filename: docFilename
                    }
                });

                // Audio
                const audioUrl = document.getElementById('combo-audio-url').value;
                if (audioUrl) {
                    payloads.push({
                        recipient_type: recipient.includes('@g.us') ? 'group' : 'individual',
                        to: recipient,
                        type: 'audio',
                        audio: {
                            link: audioUrl,
                            ptt: document.getElementById('combo-audio-ptt').checked
                        }
                    });
                }

                // Video
                const videoUrl = document.getElementById('combo-video-url').value;
                if (videoUrl) {
                    payloads.push({
                        recipient_type: recipient.includes('@g.us') ? 'group' : 'individual',
                        to: recipient,
                        type: 'video',
                        video: {
                            link: videoUrl,
                            caption: document.getElementById('combo-video-caption').value || ''
                        }
                    });
                }

                const curlCommand = `curl -X POST "${window.location.origin}${endpoint}" \\\n-H "Authorization: Bearer ${currentToken}" \\\n-H "Content-Type: application/json" \\\n-d '${JSON.stringify(payloads, null, 2)}'`;

                apiUsageExample.textContent = curlCommand;
                return; // Exit early since we already set the curl command
            }

            const curlCommand = `curl -X POST "${window.location.origin}${endpoint}" \\\n-H "Authorization: Bearer ${currentToken}" \\\n-H "Content-Type: application/json" \\\n-d '${JSON.stringify(payload, null, 2)}'`;

            apiUsageExample.textContent = curlCommand;
        }


        async function sendApiRequest(payload) {
            const sessionId = apiSessionIdSelect.value;
            const sessionData = sessionsData.get(sessionId);
            if (!sessionId || !sessionData || !sessionData.token) {
                showSwalAlert('Error', 'Please select an active session. Token not found.', 'error');
                return;
            }

            const currentToken = sessionData.token;

            apiResponseDiv.innerHTML = `<div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div>`;

            try {
                const response = await fetch(`/api/v1/messages?sessionId=${sessionId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const resultHtml = `<div class="alert ${response.ok ? 'alert-success' : 'alert-danger'} mt-3">
                                <pre>${JSON.stringify(result, null, 2)}</pre>
                            </div>`;
                apiResponseDiv.innerHTML = resultHtml;

            } catch (error) {
                apiResponseDiv.innerHTML = `<div class="alert alert-danger mt-3">Error: ${error.message}</div>`;
            }
        }


        async function sendTextMessage() {
            const recipient = apiRecipientInput.value;
            const message = document.getElementById('text-message').value;
            if (!recipient || !message) {
                showSwalAlert('Error', 'Recipient and message are required.', 'error');
                return;
            }
            const payload = {
                recipient_type: recipient.includes('@g.us') ? 'group' : 'individual',
                to: recipient,
                type: 'text',
                text: { body: message }
            };
            await sendApiRequest([payload]);
        }

        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            apiResponseDiv.innerHTML = `<div class="spinner-border spinner-border-sm" role="status"></div> <span>Uploading file...</span>`;

            const sessionId = apiSessionIdSelect.value;
            const sessionData = sessionsData.get(sessionId);
            const currentToken = sessionData ? sessionData.token : Array.from(sessionsData.values())[0]?.token; // Use first available token for global upload

            if (!currentToken) {
                apiResponseDiv.innerHTML = `<div class="alert alert-danger mt-3">Upload Error: No valid token found to authenticate.</div>`;
                return null;
            }

            try {
                const response = await fetch('/api/v1/media', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: formData
                });
                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.message || 'File upload failed.');
                }
                apiResponseDiv.innerHTML = `<div class="alert alert-info">File uploaded. Media ID: ${result.mediaId}</div>`;
                return result.mediaId;
            } catch (error) {
                apiResponseDiv.innerHTML = `<div class="alert alert-danger mt-3">Upload Error: ${error.message}</div>`;
                return null;
            }
        }

        async function sendImageMessage() {
            const recipient = apiRecipientInput.value;
            const caption = document.getElementById('image-caption').value;
            const imageUrl = document.getElementById('image-url').value;
            const imageFile = imageUploadInput.files[0];

            if (!recipient) {
                showSwalAlert('Error', 'Recipient is required.', 'error');
                return;
            }
            if (!imageUrl && !imageFile) {
                showSwalAlert('Error', 'Image URL or an uploaded file is required.', 'error');
                return;
            }

            let imagePayload = {};
            if (imageFile) {
                const mediaId = await uploadFile(imageFile);
                if (!mediaId) return; // Upload failed
                imagePayload.id = mediaId;
            } else {
                imagePayload.link = imageUrl;
            }

            const payload = {
                recipient_type: recipient.includes('@g.us') ? 'group' : 'individual',
                to: recipient,
                type: 'image',
                image: { ...imagePayload, caption }
            };

            await sendApiRequest([payload]);
        }

        async function sendDocumentMessage() {
            const recipient = apiRecipientInput.value;
            const docUrl = document.getElementById('document-url').value;
            const docFile = document.getElementById('document-upload').files[0];

            if (!recipient) {
                showSwalAlert('Error', 'Recipient is required.', 'error');
                return;
            }
            if (!docUrl && !docFile) {
                showSwalAlert('Error', 'Document URL or an uploaded file is required.', 'error');
                return;
            }

            let docPayload = {};
            if (docFile) {
                const mediaId = await uploadFile(docFile);
                if (!mediaId) return; // Upload failed
                docPayload.id = mediaId;
                docPayload.mimetype = docFile.type;
                docPayload.filename = docFile.name;
            } else {
                docPayload.link = docUrl;
                docPayload.mimetype = 'application/pdf'; // Assume PDF for URL, could be improved
            }

            const payload = {
                recipient_type: recipient.includes('@g.us') ? 'group' : 'individual',
                to: recipient,
                type: 'document',
                document: { ...docPayload }
            };

            await sendApiRequest([payload]);
        }

        async function sendAudioMessage() {
            const recipient = apiRecipientInput.value;
            const audioUrl = document.getElementById('audio-url').value;
            const audioFile = document.getElementById('audio-upload').files[0];
            const ptt = document.getElementById('audio-ptt').checked;

            if (!recipient) {
                showSwalAlert('Error', 'Recipient is required.', 'error');
                return;
            }
            if (!audioUrl && !audioFile) {
                showSwalAlert('Error', 'Audio URL or an uploaded file is required.', 'error');
                return;
            }

            let audioPayload = {};
            if (audioFile) {
                const mediaId = await uploadFile(audioFile);
                if (!mediaId) return; // Upload failed
                audioPayload.id = mediaId;
                audioPayload.mimetype = audioFile.type;
            } else {
                audioPayload.link = audioUrl;
            }

            const payload = {
                recipient_type: recipient.includes('@g.us') ? 'group' : 'individual',
                to: recipient,
                type: 'audio',
                audio: { ...audioPayload, ptt }
            };

            await sendApiRequest([payload]);
        }

        async function sendVideoMessage() {
            const recipient = apiRecipientInput.value;
            const caption = document.getElementById('video-caption').value;
            const videoUrl = document.getElementById('video-url').value;
            const videoFile = document.getElementById('video-upload').files[0];

            if (!recipient) {
                showSwalAlert('Error', 'Recipient is required.', 'error');
                return;
            }
            if (!videoUrl && !videoFile) {
                showSwalAlert('Error', 'Video URL or an uploaded file is required.', 'error');
                return;
            }

            let videoPayload = {};
            if (videoFile) {
                const mediaId = await uploadFile(videoFile);
                if (!mediaId) return; // Upload failed
                videoPayload.id = mediaId;
                videoPayload.mimetype = videoFile.type;
            } else {
                videoPayload.link = videoUrl;
            }

            const payload = {
                recipient_type: recipient.includes('@g.us') ? 'group' : 'individual',
                to: recipient,
                type: 'video',
                video: { ...videoPayload, caption }
            };

            await sendApiRequest([payload]);
        }

        async function sendComboMessage() {
            const recipient = apiRecipientInput.value;
            if (!recipient) {
                showSwalAlert('Error', 'Recipient is required.', 'error');
                return;
            }

            const payloads = [];

            // Text message
            const textMessage = document.getElementById('combo-text-message').value;
            if (textMessage) {
                payloads.push({
                    recipient_type: recipient.includes('@g.us') ? 'group' : 'individual',
                    to: recipient,
                    type: 'text',
                    text: { body: textMessage }
                });
            }

            // Image message
            const imageCaption = document.getElementById('combo-image-caption').value;
            const imageUrl = document.getElementById('combo-image-url').value;
            const imageFile = document.getElementById('combo-image-upload').files[0];

            if (imageUrl || imageFile) {
                let imagePayload = {};
                if (imageFile) {
                    const mediaId = await uploadFile(imageFile);
                    if (!mediaId) {
                        showSwalAlert('Warning', 'Image upload failed. Continuing with other messages...', 'warning');
                    } else {
                        imagePayload.id = mediaId;
                    }
                } else {
                    imagePayload.link = imageUrl;
                }

                if (imagePayload.id || imagePayload.link) {
                    payloads.push({
                        recipient_type: recipient.includes('@g.us') ? 'group' : 'individual',
                        to: recipient,
                        type: 'image',
                        image: { ...imagePayload, caption: imageCaption }
                    });
                }
            }

            // Document message
            const docUrl = document.getElementById('combo-document-url').value;
            const docFile = document.getElementById('combo-document-upload').files[0];
            const docFilename = document.getElementById('combo-document-filename').value;

            if (docUrl || docFile) {
                let docPayload = {};
                if (docFile) {
                    const mediaId = await uploadFile(docFile);
                    if (!mediaId) {
                        showSwalAlert('Warning', 'Document upload failed. Continuing with other messages...', 'warning');
                    } else {
                        docPayload.id = mediaId;
                        docPayload.mimetype = docFile.type;
                        docPayload.filename = docFilename || docFile.name;
                    }
                } else {
                    docPayload.link = docUrl;
                    docPayload.mimetype = 'application/pdf'; // Default mimetype
                    if (docFilename) {
                        docPayload.filename = docFilename;
                    }
                }

                if (docPayload.id || docPayload.link) {
                    payloads.push({
                        recipient_type: recipient.includes('@g.us') ? 'group' : 'individual',
                        to: recipient,
                        type: 'document',
                        document: { ...docPayload }
                    });
                }
            }

            // Audio message
            const comboAudioUrl = document.getElementById('combo-audio-url').value;
            const comboAudioFile = document.getElementById('combo-audio-upload').files[0];
            const comboAudioPtt = document.getElementById('combo-audio-ptt').checked;

            if (comboAudioUrl || comboAudioFile) {
                let audioPayload = {};
                if (comboAudioFile) {
                    const mediaId = await uploadFile(comboAudioFile);
                    if (!mediaId) {
                        showSwalAlert('Warning', 'Audio upload failed. Continuing with other messages...', 'warning');
                    } else {
                        audioPayload.id = mediaId;
                        audioPayload.mimetype = comboAudioFile.type;
                    }
                } else {
                    audioPayload.link = comboAudioUrl;
                }

                if (audioPayload.id || audioPayload.link) {
                    payloads.push({
                        recipient_type: recipient.includes('@g.us') ? 'group' : 'individual',
                        to: recipient,
                        type: 'audio',
                        audio: { ...audioPayload, ptt: comboAudioPtt }
                    });
                }
            }

            // Video message
            const comboVideoCaption = document.getElementById('combo-video-caption').value;
            const comboVideoUrl = document.getElementById('combo-video-url').value;
            const comboVideoFile = document.getElementById('combo-video-upload').files[0];

            if (comboVideoUrl || comboVideoFile) {
                let videoPayload = {};
                if (comboVideoFile) {
                    const mediaId = await uploadFile(comboVideoFile);
                    if (!mediaId) {
                        showSwalAlert('Warning', 'Video upload failed. Continuing with other messages...', 'warning');
                    } else {
                        videoPayload.id = mediaId;
                        videoPayload.mimetype = comboVideoFile.type;
                    }
                } else {
                    videoPayload.link = comboVideoUrl;
                }

                if (videoPayload.id || videoPayload.link) {
                    payloads.push({
                        recipient_type: recipient.includes('@g.us') ? 'group' : 'individual',
                        to: recipient,
                        type: 'video',
                        video: { ...videoPayload, caption: comboVideoCaption }
                    });
                }
            }

            if (payloads.length === 0) {
                showSwalAlert('Info', 'Please add at least one message (text, image, document, audio, or video).', 'info');
                return;
            }

            await sendApiRequest(payloads);
        }

        // Event Listeners
        imageUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.innerHTML = `<img src="${e.target.result}" class="img-fluid rounded">`;
                };
                reader.readAsDataURL(file);
                document.getElementById('image-url').value = ''; // Clear URL field
            }
        });

        // Combo image upload preview
        const comboImageUploadInput = document.getElementById('combo-image-upload');
        const comboImagePreview = document.getElementById('combo-image-preview');

        comboImageUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    comboImagePreview.innerHTML = `<img src="${e.target.result}" class="img-fluid rounded">`;
                };
                reader.readAsDataURL(file);
                document.getElementById('combo-image-url').value = ''; // Clear URL field
            }
        });

        document.getElementById('combo-image-url').addEventListener('input', () => {
            comboImageUploadInput.value = ''; // Clear file input
            comboImagePreview.innerHTML = '';
        });

        document.getElementById('image-url').addEventListener('input', () => {
            imageUploadInput.value = ''; // Clear file input
            imagePreview.innerHTML = '';
        });

        document.getElementById('audio-url').addEventListener('input', () => {
            document.getElementById('audio-upload').value = ''; // Clear file input
        });

        document.getElementById('video-url').addEventListener('input', () => {
            document.getElementById('video-upload').value = ''; // Clear file input
        });

        document.getElementById('audio-upload').addEventListener('change', () => {
            document.getElementById('audio-url').value = ''; // Clear URL input
        });

        document.getElementById('video-upload').addEventListener('change', () => {
            document.getElementById('video-url').value = ''; // Clear URL input
        });

        document.getElementById('document-upload').addEventListener('change', () => {
            document.getElementById('document-url').value = ''; // Clear URL input
        });

        document.getElementById('document-url').addEventListener('input', () => {
            document.getElementById('document-upload').value = ''; // Clear file input
        });

        document.getElementById('combo-audio-url').addEventListener('input', () => {
            document.getElementById('combo-audio-upload').value = ''; // Clear file input
        });

        document.getElementById('combo-audio-upload').addEventListener('change', () => {
            document.getElementById('combo-audio-url').value = ''; // Clear URL input
        });

        document.getElementById('combo-video-url').addEventListener('input', () => {
            document.getElementById('combo-video-upload').value = ''; // Clear file input
        });

        document.getElementById('combo-video-upload').addEventListener('change', () => {
            document.getElementById('combo-video-url').value = ''; // Clear URL input
        });

        document.getElementById('combo-document-url').addEventListener('input', () => {
            document.getElementById('combo-document-upload').value = ''; // Clear file input
        });

        document.getElementById('combo-document-upload').addEventListener('change', () => {
            document.getElementById('combo-document-url').value = ''; // Clear URL input
        });

        document.querySelectorAll('#api-tab-content input, #api-tab-content textarea, #api-session-id').forEach(el => {
            el.addEventListener('input', updateApiUsage);
        });
        document.querySelectorAll('#api-tabs .nav-link').forEach(tab => {
            tab.addEventListener('shown.bs.tab', updateApiUsage);
        });

        // Add input event listener to convert spaces to underscores as user types
        sessionIdInput.addEventListener('input', (e) => {
            const cursorPosition = e.target.selectionStart;
            const originalValue = e.target.value;
            const newValue = originalValue.replace(/\s/g, '_');

            if (originalValue !== newValue) {
                e.target.value = newValue;
                // Maintain cursor position
                e.target.setSelectionRange(cursorPosition, cursorPosition);
            }
        });

        createSessionBtn.addEventListener('click', async () => {
            const sessionId = sessionIdInput.value.trim();
            if (!sessionId) {
                showSwalAlert('Error', 'Please enter a Session ID.', 'error');
                return;
            }

            // Convert spaces to underscores
            const sanitizedSessionId = sessionId.replace(/\s+/g, '_');

            try {
                const response = await fetch('/api/v1/sessions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin', // Include session cookie
                    body: JSON.stringify({ sessionId: sanitizedSessionId })
                });
                const result = await response.json();
                if (response.ok) {
                    sessionIdInput.value = '';

                    // Wait a moment for QR code to be generated before fetching sessions
                    setTimeout(async () => {
                        await fetchSessions();
                    }, 1000);
                } else {
                    throw new Error(result.message || 'Failed to create session');
                }
            } catch (error) {
                showSwalAlert('Error', `An error occurred while creating the session: ${error.message}`, 'error');
            }
        });

        function initializeWebSocket() {
            fetch('/admin/ws-token')
                .then(res => res.json())
                .then(response => {
                    if (response.status !== 'success' || !response.data) {
                        throw new Error('Failed to get WebSocket token');
                    }
                    const data = response.data;
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const ws = new WebSocket(`${protocol}//${window.location.host}?token=${data.token}`);

                    ws.onopen = () => {
                        appendLogEntry({
                            timestamp: new Date().toISOString(),
                            level: 'INFO',
                            sessionId: 'SYSTEM',
                            message: 'Live log stream connected.'
                        });
                    };

                    ws.onmessage = (event) => {
                        const logData = JSON.parse(event.data);
                        if (logData.type === 'log') {
                            if (logsPaused) {
                                logBuffer.push(logData);
                            } else {
                                appendLogEntry(logData);
                            }
                        } else if (logData.type === 'session-update') {
                            const sessions = logData.data;
                            updateSessionCards(sessions);
                            updateApiSessionSelect(sessions);
                        }
                    };

                    ws.onclose = () => {
                        appendLogEntry({
                            timestamp: new Date().toISOString(),
                            level: 'ERROR',
                            sessionId: 'SYSTEM',
                            message: 'Log stream disconnected. Reconnecting in 5s...'
                        });
                        setTimeout(initializeWebSocket, 5000);
                    };

                    ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        ws.close();
                    };
                })
                .catch(error => {
                    console.error('Failed to get WebSocket auth token:', error);
                    setTimeout(initializeWebSocket, 5000);
                });
        }

        function appendLogEntry(log) {
            allLogs.push(log);
            if (allLogs.length > MAX_LOGS) allLogs.shift();

            // Check if it passes current filters
            if (!shouldShowLog(log)) return;

            renderLogEntry(log);
        }

        function shouldShowLog(log) {
            const level = logLevelFilter.value;
            const session = logSessionFilter.value;
            const search = logSearchInput.value.toLowerCase();

            if (level !== 'all' && log.level !== level) return false;
            if (session !== 'all' && log.sessionId !== session) return false;
            if (search && !log.message.toLowerCase().includes(search) && !log.sessionId.toLowerCase().includes(search)) return false;

            return true;
        }

        function renderLogEntry(log) {
            const entry = document.createElement('div');
            entry.className = `log-entry level-${log.level.toLowerCase()}`;

            const time = new Date(log.timestamp).toLocaleTimeString();
            const detailsHtml = log.details ? `
                <i class="bi bi-info-circle log-details-toggle" onclick="toggleLogDetails(this)"></i>
                <div class="log-details-content"><pre class="mb-0">${JSON.stringify(log.details, null, 2)}</pre></div>
            ` : '';

            entry.innerHTML = `
                <span class="log-time">${time}</span>
                <span class="log-level lvl-${log.level.toLowerCase()}-badge">${log.level}</span>
                <span class="log-context" onclick="filterBySession('${sanitize(log.sessionId)}')">[${sanitize(log.sessionId)}]</span>
                <span class="log-msg">${sanitize(log.message)}</span>
                ${detailsHtml}
            `;

            logBox.appendChild(entry);

            // Keep scroll at bottom unless user has scrolled up
            const isScrolledToBottom = logBox.scrollHeight - logBox.clientHeight <= logBox.scrollTop + 50;
            if (isScrolledToBottom) {
                logBox.scrollTop = logBox.scrollHeight;
            }

            // Prune DOM entries
            if (logBox.children.length > MAX_LOGS) {
                logBox.removeChild(logBox.firstChild);
            }
        }

        function toggleLogDetails(el) {
            const content = el.nextElementSibling;
            content.style.display = content.style.display === 'block' ? 'none' : 'block';
            el.classList.toggle('bi-info-circle');
            el.classList.toggle('bi-info-circle-fill');
        }

        function filterBySession(sessionId) {
            logSessionFilter.value = sessionId;
            refreshLogs();
        }

        function refreshLogs() {
            logBox.innerHTML = '';
            allLogs.forEach(log => {
                if (shouldShowLog(log)) renderLogEntry(log);
            });
        }

        // --- Event Listeners for Terminal ---
        logSearchInput.addEventListener('input', refreshLogs);
        logLevelFilter.addEventListener('change', refreshLogs);
        logSessionFilter.addEventListener('change', refreshLogs);

        clearLogsBtn.addEventListener('click', () => {
            allLogs = [];
            logBox.innerHTML = '';
            appendLogEntry({
                timestamp: new Date().toISOString(),
                level: 'INFO',
                sessionId: 'SYSTEM',
                message: 'Terminal cleared.'
            });
        });

        pauseLogsBtn.addEventListener('click', () => {
            logsPaused = !logsPaused;
            if (logsPaused) {
                pauseLogsBtn.innerHTML = '<i class="bi bi-play-fill"></i> Resume';
                pauseLogsBtn.classList.replace('btn-outline-light', 'btn-warning');
                pauseLogsBtn.classList.add('text-dark');
            } else {
                pauseLogsBtn.innerHTML = '<i class="bi bi-pause-fill"></i> Pause';
                pauseLogsBtn.classList.replace('btn-warning', 'btn-outline-light');
                pauseLogsBtn.classList.remove('text-dark');

                // Flush buffer
                logBuffer.forEach(appendLogEntry);
                logBuffer = [];
            }
        });

        function loadSessions() {
            // Initial load of sessions via HTTP, then rely on websocket
            fetchSessions();
        }

        function copySessionToken(sessionId) {
            const tokenEl = document.getElementById(`token-${sessionId}`);
            if (!tokenEl) return;

            tokenEl.select();
            tokenEl.setSelectionRange(0, 99999);

            navigator.clipboard.writeText(tokenEl.value).then(() => {
                // Optional: Show a "Copied!" tooltip or message
            }, (err) => {
                console.error('Could not copy text: ', err);
            });
        }

        function updateApiSessionSelect(sessions) {
            apiSessionIdSelect.innerHTML = '';

            // Sync log session filter too
            const currentFilter = logSessionFilter.value;
            logSessionFilter.innerHTML = '<option value="all">All Sessions</option><option value="SYSTEM">SYSTEM</option>';

            sessions.forEach(session => {
                // Populate session select for messaging
                if (session.status === 'CONNECTED') {
                    const option = document.createElement('option');
                    option.value = session.sessionId;
                    option.textContent = session.sessionId;
                    apiSessionIdSelect.appendChild(option);
                }

                // Populate log filter (all sessions regardless of status)
                const filterOption = document.createElement('option');
                filterOption.value = session.sessionId;
                filterOption.textContent = session.sessionId;
                logSessionFilter.appendChild(filterOption);
            });

            // Restore filter selection
            logSessionFilter.value = currentFilter || 'all';

            // Optionally, select the first session if available
            if (apiSessionIdSelect.options.length > 0) {
                apiSessionIdSelect.selectedIndex = 0;
                updateApiUsage();
            }
        }

        function updateApiUsageExample() {
            const sessionId = apiSessionIdSelect.value;
            const recipient = apiRecipientInput.value;
            if (!sessionId || !recipient) {
                apiUsageExample.textContent = 'Please select a session and enter a recipient to see an example.';
                return;
            }

            const activeTabEl = document.querySelector('#api-tabs .nav-link.active');
            if (!activeTabEl) return;
            const activeTab = activeTabEl.id;

            let payload;
            let endpoint = `/api/v1/messages?sessionId=${sessionId}`;
            const sessionData = sessionsData.get(sessionId);
            const currentToken = sessionData ? sessionData.token : '';

            if (activeTab === 'text-tab') {
                const message = document.getElementById('text-message').value;
                payload = {
                    recipient_type: recipient.includes('@g.us') ? 'group' : 'individual',
                    to: recipient,
                    type: 'text',
                    text: { body: message }
                };
            } else if (activeTab === 'image-tab') {
                const caption = document.getElementById('image-caption').value;
                const imageUrl = document.getElementById('image-url').value;
                payload = {
                    recipient_type: recipient.includes('@g.us') ? 'group' : 'individual',
                    to: recipient,
                    type: 'image',
                    image: {
                        link: imageUrl,
                        caption: caption
                    }
                };
                if (!imageUrl) {
                    apiUsageExample.textContent = `// 1. First, upload the image to /api/v1/media\n// 2. Then, use the returned mediaId in the request below.\n\n`
                }
            } else if (activeTab === 'document-tab') {
                const docUrl = document.getElementById('document-url').value;
                payload = {
                    recipient_type: recipient.includes('@g.us') ? 'group' : 'individual',
                    to: recipient,
                    type: 'document',
                    document: {
                        link: docUrl,
                        mimetype: 'application/pdf' // Example mimetype
                    }
                };
                if (!docUrl) {
                    apiUsageExample.textContent = `// 1. First, upload the document to /api/v1/media\n// 2. Then, use the returned mediaId in the request below.\n\n`
                }
            } else if (activeTab === 'combo-tab') {
                // Build payload array for combo
                const payloads = [];

                // Text
                const textMessage = document.getElementById('combo-text-message').value || 'Hello! Here is an image and a document.';
                payloads.push({
                    recipient_type: recipient.includes('@g.us') ? 'group' : 'individual',
                    to: recipient,
                    type: 'text',
                    text: { body: textMessage }
                });

                // Image
                const imageCaption = document.getElementById('combo-image-caption').value || 'Image caption';
                const imageUrl = document.getElementById('combo-image-url').value || 'https://picsum.photos/200';
                payloads.push({
                    recipient_type: recipient.includes('@g.us') ? 'group' : 'individual',
                    to: recipient,
                    type: 'image',
                    image: {
                        link: imageUrl,
                        caption: imageCaption
                    }
                });

                // Document
                const docUrl = document.getElementById('combo-document-url').value || 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf';
                const docFilename = document.getElementById('combo-document-filename').value || 'document.pdf';
                payloads.push({
                    recipient_type: recipient.includes('@g.us') ? 'group' : 'individual',
                    to: recipient,
                    type: 'document',
                    document: {
                        link: docUrl,
                        mimetype: 'application/pdf',
                        filename: docFilename
                    }
                });

                const curlCommand = `curl -X POST "${window.location.origin}${endpoint}" \\\n-H "Authorization: Bearer ${currentToken}" \\\n-H "Content-Type: application/json" \\\n-d '${JSON.stringify(payloads, null, 2)}'`;

                apiUsageExample.textContent = curlCommand;
                return; // Exit early since we already set the curl command
            }

            const curlCommand = `curl -X POST "${window.location.origin}${endpoint}" \\\n-H "Authorization: Bearer ${currentToken}" \\\n-H "Content-Type: application/json" \\\n-d '${JSON.stringify(payload, null, 2)}'`;

            apiUsageExample.textContent = curlCommand;
        }

        function copyToClipboard(inputId, btn) {
            const input = document.getElementById(inputId);
            input.select();
            input.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(input.value).then(() => {
                const original = btn.innerHTML;
                btn.innerHTML = '<i class="bi bi-clipboard-check"></i>';
                btn.classList.remove('btn-outline-secondary');
                btn.classList.add('btn-info');
                btn.style.borderRadius = '6px';
                setTimeout(() => {
                    btn.innerHTML = original;
                    btn.classList.remove('btn-info');
                    btn.classList.add('btn-outline-secondary');
                    btn.style.borderRadius = '';
                }, 1200);
            });
        }

        // System Log History
        let bulkSelectMode = false;
        let selectedLogs = new Set();

        function renderSystemLogHistory() {
            console.log('Debug: Rendering System Log History...');
            const logContainer = document.getElementById('systemLogHistory');
            if (!logContainer) {
                console.error('Debug: systemLogHistory element not found!');
                return;
            }

            if (!window.systemLogData || window.systemLogData.length === 0) {
                console.log('Debug: window.systemLogData is empty or undefined.');
                logContainer.innerHTML = '<div class="text-muted text-center p-4"><i class="bi bi-inbox fs-1"></i><br>No log entries to display.</div>';
                console.log('Debug: No log entries to render.');
                return;
            }

            console.log('Debug: Found', window.systemLogData.length, 'log entries to render.');

            // Create array with original indices before sorting
            const logsWithIndex = window.systemLogData.map((log, index) => ({
                log: log,
                originalIndex: index
            }));

            // Sort logs by timestamp (newest first)
            const sortedLogs = logsWithIndex.sort((a, b) =>
                new Date(b.log.timestamp) - new Date(a.log.timestamp)
            );

            const logHtml = sortedLogs.map((item, displayIndex) => {
                const log = item.log;
                const originalIndex = item.originalIndex;
                const date = new Date(log.timestamp);
                const formattedDate = date.toLocaleString();
                const phoneNumbers = log.details.phoneNumbers ? log.details.phoneNumbers.map(num => sanitize(num)).join(', ') : 'N/A';
                const uniqueId = `log-${displayIndex}-${Date.now()}`;

                // Create summary info
                let summaryInfo = `<span class="text-muted">${log.details.count || 1} message(s) to ${phoneNumbers}</span>`;

                // Format message details for the collapsible section
                let detailsContent = `
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Session:</strong> ${sanitize(log.sessionId)}</p>
                            <p class="mb-1"><strong>Recipients:</strong> ${phoneNumbers}</p>
                            <p class="mb-1"><strong>Count:</strong> ${log.details.count || 1}</p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Event:</strong> ${sanitize(log.details.event || '')}</p>
                            <p class="mb-1"><strong>Time:</strong> ${formattedDate}</p>
                        </div>
                    </div>
                `;

                // Display message content if available
                if (log.details.messages && log.details.messages.length > 0) {
                    detailsContent += '<hr class="my-3">';
                    detailsContent += '<h6 class="mb-3">Message Content:</h6>';
                    detailsContent += '<div class="message-list">';

                    log.details.messages.forEach((msg, msgIndex) => {
                        detailsContent += `
                            <div class="message-item mb-3 p-3 border rounded bg-body-secondary">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <span class="badge bg-primary">${sanitize(msg.type).toUpperCase()}</span>
                                    <small class="text-muted">To: ${sanitize(msg.to)}</small>
                                </div>
                        `;

                        if (msg.type === 'text' && msg.text) {
                            // Preserve formatting by converting newlines to <br> and escaping HTML
                            const formattedText = sanitize(msg.text).replace(/\n/g, '<br>');
                            detailsContent += `
                                <div class="message-content">
                                    <div class="text-break">${formattedText}</div>
                                </div>
                            `;
                        } else if (msg.type === 'image' && msg.image) {
                            detailsContent += `
                                <div class="message-content">
                            `;

                            // Show image preview if it's a local media file or external URL
                            const imageUrl = sanitize(msg.image.url);
                            if (imageUrl.startsWith('/media/') || imageUrl.startsWith('http')) {
                                detailsContent += `
                                    <div class="mb-2">
                                        <img src="${imageUrl}" class="img-thumbnail" style="max-width: 300px; max-height: 300px; cursor: pointer;" 
                                             onclick="showImageLightbox('${imageUrl}')"
                                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                        <div style="display: none;">
                                            <i class="bi bi-image-fill text-muted" style="font-size: 3rem;"></i>
                                            <p class="text-muted">Image preview unavailable</p>
                                        </div>
                                    </div>
                                `;
                            }

                            detailsContent += `
                                    <p class="mb-1"><i class="bi bi-image"></i> Image: <a href="${imageUrl}" target="_blank" class="text-decoration-none">${imageUrl}</a></p>
                            `;

                            if (msg.image.caption) {
                                const formattedCaption = sanitize(msg.image.caption).replace(/\n/g, '<br>');
                                detailsContent += `
                                    <div class="mt-2 caption-box">
                                        <small><strong>Caption:</strong></small><br>
                                        <div style="white-space: pre-wrap;">${formattedCaption}</div>
                                    </div>
                                `;
                            }
                            detailsContent += `</div>`;
                        } else if (msg.type === 'document' && msg.document) {
                            const docUrl = sanitize(msg.document.url);
                            const filename = sanitize(msg.document.filename);

                            detailsContent += `
                                <div class="message-content">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="bi bi-file-earmark-text-fill text-primary" style="font-size: 2rem; margin-right: 10px;"></i>
                                        <div>
                                            <p class="mb-0"><strong>${filename}</strong></p>
                                            <a href="${docUrl}" target="_blank" class="text-decoration-none">
                                                <i class="bi bi-download"></i> Download Document
                                            </a>
                                        </div>
                                    </div>
                                    <small class="text-muted">URL: ${docUrl}</small>
                                </div>
                            `;
                        }

                        detailsContent += `</div>`;
                    });

                    detailsContent += '</div>';
                }

                // Add delete button at the bottom of details - use originalIndex (only for admins)
                if (currentUserRole === 'admin') {
                    detailsContent += `
                        <hr class="my-3">
                        <div class="text-end">
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteLogEntry(${originalIndex})">
                                <i class="bi bi-trash"></i> Delete This Log Entry
                            </button>
                        </div>
                    `;
                }

                return `
                    <div class="log-entry-card mb-2" data-log-index="${originalIndex}">
                        <div class="card">
                            <div class="card-header py-2" role="button" data-bs-toggle="collapse" data-bs-target="#${uniqueId}" aria-expanded="false" aria-controls="${uniqueId}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <input type="checkbox" class="form-check-input me-2 bulk-checkbox d-none" 
                                               data-log-index="${originalIndex}" 
                                               onclick="event.stopPropagation(); toggleLogSelection(${originalIndex})">
                                        <div>
                                            <i class="bi bi-clock-history me-2"></i>
                                            <strong>${sanitize(log.sessionId)}</strong>
                                            <span class="mx-2">•</span>
                                            ${summaryInfo}
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <small class="text-muted me-3">${formattedDate}</small>
                                        <i class="bi bi-chevron-down"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="collapse" id="${uniqueId}">
                                <div class="card-body">
                                    ${detailsContent}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            logContainer.innerHTML = logHtml;
        }

        // Make it globally accessible
        window.renderSystemLogHistory = renderSystemLogHistory;

        // Bulk selection functions
        function toggleBulkSelect() {
            bulkSelectMode = !bulkSelectMode;
            const bulkActions = document.getElementById('bulkActions');
            const bulkSelectBtn = document.getElementById('bulkSelectBtn');
            const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
            const checkboxes = document.querySelectorAll('.bulk-checkbox');

            if (bulkSelectMode) {
                bulkActions.classList.remove('d-none');
                bulkSelectBtn.innerHTML = '<i class="bi bi-x-square"></i> Cancel';
                bulkSelectBtn.classList.add('btn-outline-secondary');
                bulkSelectBtn.classList.remove('btn-outline-light');
                checkboxes.forEach(cb => cb.classList.remove('d-none'));
            } else {
                cancelBulkSelect();
            }
        }

        function cancelBulkSelect() {
            bulkSelectMode = false;
            selectedLogs.clear();
            const bulkActions = document.getElementById('bulkActions');
            const bulkSelectBtn = document.getElementById('bulkSelectBtn');
            const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
            const checkboxes = document.querySelectorAll('.bulk-checkbox');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');

            bulkActions.classList.add('d-none');
            bulkSelectBtn.innerHTML = '<i class="bi bi-check-square"></i> Select';
            bulkSelectBtn.classList.remove('btn-outline-secondary');
            bulkSelectBtn.classList.add('btn-outline-light');
            deleteSelectedBtn.classList.add('d-none');
            checkboxes.forEach(cb => {
                cb.checked = false;
                cb.classList.add('d-none');
            });
            selectAllCheckbox.checked = false;
            updateSelectedCount();
        }

        function toggleLogSelection(index) {
            if (selectedLogs.has(index)) {
                selectedLogs.delete(index);
            } else {
                selectedLogs.add(index);
            }
            updateSelectedCount();
        }

        function selectAllLogs() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const checkboxes = document.querySelectorAll('.bulk-checkbox');

            if (selectAllCheckbox.checked) {
                checkboxes.forEach(cb => {
                    cb.checked = true;
                    const index = parseInt(cb.getAttribute('data-log-index'));
                    selectedLogs.add(index);
                });
            } else {
                checkboxes.forEach(cb => {
                    cb.checked = false;
                });
                selectedLogs.clear();
            }
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const selectedCount = document.getElementById('selectedCount');
            const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');

            selectedCount.textContent = `${selectedLogs.size} selected`;

            if (selectedLogs.size > 0) {
                deleteSelectedBtn.classList.remove('d-none');
            } else {
                deleteSelectedBtn.classList.add('d-none');
            }
        }

        async function deleteLogEntry(index) {
            const result = await Swal.fire({
                title: 'Delete Log?',
                text: 'Are you sure you want to delete this log entry?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Yes, delete it!'
            });

            if (!result.isConfirmed) {
                return;
            }

            // Remove from systemLogData
            window.systemLogData.splice(index, 1);

            // Update the system.log file
            updateSystemLogFile();

            // Re-render the log history
            renderSystemLogHistory();

            // Show success message
            showToast('Log entry deleted successfully', 'success');
        }

        async function deleteSelectedLogs() {
            if (selectedLogs.size === 0) return;

            const count = selectedLogs.size;
            const result = await Swal.fire({
                title: 'Delete Selected Logs?',
                text: `Are you sure you want to delete ${count} log entries?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Yes, delete them!'
            });

            if (!result.isConfirmed) {
                return;
            }

            // Sort indices in reverse order to avoid index shifting issues
            const indicesToDelete = Array.from(selectedLogs).sort((a, b) => b - a);

            // Remove from systemLogData
            indicesToDelete.forEach(index => {
                window.systemLogData.splice(index, 1);
            });

            // Update the system.log file
            updateSystemLogFile();

            // Clear selection and re-render
            cancelBulkSelect();
            renderSystemLogHistory();

            // Show success message
            showToast(`${count} log entries deleted successfully`, 'success');
        }

        function updateSystemLogFile() {
            // Send updated log data to server
            fetch('/admin/update-logs', {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ logs: window.systemLogData })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to update log file');
                    }
                })
                .catch(error => {
                    console.error('Error updating log file:', error);
                    showToast('Error updating log file', 'danger');
                });
        }

        function showToast(message, type = 'info') {
            // Create toast container if it doesn't exist
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.className = 'position-fixed bottom-0 end-0 p-3';
                toastContainer.style.zIndex = '1050';
                document.body.appendChild(toastContainer);
            }

            const toastId = `toast-${Date.now()}`;
            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;

            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement);
            toast.show();

            // Remove toast element after it's hidden
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }

        function refreshSystemLog() {
            location.reload();
        }

        function exportSystemLog() {
            if (!window.systemLogData || window.systemLogData.length === 0) {
                showSwalAlert('No Data', 'No log data to export.', 'warning');
                return;
            }

            const dataStr = JSON.stringify(window.systemLogData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

            const exportFileDefaultName = `system-log-${new Date().toISOString().slice(0, 10)}.json`;

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        // Image Lightbox Functions
        function showImageLightbox(imageUrl) {
            const lightboxImage = document.getElementById('lightboxImage');
            lightboxImage.src = imageUrl;
            const myModal = new bootstrap.Modal(document.getElementById('imageLightbox'));
            myModal.show();
        }

        // Authentication and user info
        let currentUserEmail = '';
        let currentUserRole = '';

        async function checkAuth() {
            try {
                const res = await fetch('/admin/me');
                if (!res.ok) {
                    window.location.href = '/admin/login.html';
                    return false;
                }
                const response = await res.json();
                const user = response.data;

                if (!user) {
                    window.location.href = '/admin/login.html';
                    return false;
                }

                currentUserEmail = user.email;
                currentUserRole = user.role;

                // Display user info
                document.getElementById('currentUser').textContent = `${user.email} (${user.role})`;

                // Show Users menu only for admins
                if (user.role === 'admin') {
                    document.getElementById('nav-users').style.display = 'block';
                    document.getElementById('nav-activities').style.display = 'block';
                }

                // Apply role-based restrictions
                applyRoleRestrictions();

                return true;
            } catch (error) {
                window.location.href = '/admin/login.html';
                return false;
            }
        }

        function applyRoleRestrictions() {
            if (currentUserRole !== 'admin') {
                // Hide delete buttons in session cards (will be done when rendering)
                // Hide log deletion features
                const bulkSelectSection = document.querySelector('.d-flex.justify-content-between.align-items-center:has(#bulkSelectBtn)');
                if (bulkSelectSection) {
                    bulkSelectSection.style.display = 'none';
                }

                // Disable log deletion buttons (will be handled in renderSystemLogHistory)
            }
        }

        // Main setup
        document.addEventListener('DOMContentLoaded', async () => {
            // Check authentication first
            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) return;

            function sanitize(str) {
                if (!str) return '';
                return str
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            }

            initializeWebSocket();
            loadSessions();
            renderSystemLogHistory(); // Render logs on page load
        });

        document.getElementById('logout-btn').addEventListener('click', async function () {
            const btn = this;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Logging out...';
            try {
                const res = await fetch('/admin/logout', { method: 'POST', credentials: 'same-origin', headers: { 'Content-Type': 'application/json' } });
                if (res.status === 401) {
                    window.location.href = '/admin/login.html';
                    return;
                }
                const data = await res.json();
                if (data && data.data && data.data.redirect) {
                    window.location.href = data.data.redirect;
                } else {
                    window.location.reload();
                }
            } catch (e) {
                window.location.href = '/admin/login.html';
            }
        });

    </script>
</body>

</html>